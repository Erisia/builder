# Erisia server-builder <a href="https://travis-ci.org/Erisia/builder"><img align="right" src="https://travis-ci.org/Erisia/builder.svg?branch=master"></a>
Build scripts for the server

## Dependencies

The only real dependency is Nix. You *can* acquire this by installing NixOS, but you probably won't want to. <a href="https://nixos.org/nix/">Nix</a> can be installed on any Linux system, following the instructions on that page.

It also works in Windows WSL, but you'll need to first follow <a href="https://github.com/NixOS/nix/issues/1203#issuecomment-275089112">these instructions</a> to work around a current bug in WSL.

## Quick start

Make a server directory, then run update-and-start.sh using its relative path. Example:
```
$ mkdir erisia
$ cd erisia
$ jj git clone https://github.com/Erisia/builder.git builder
$ builder/update-and-start.sh
```

### Website

The Erisia website is available in two implementations:
- **Jekyll** (legacy): In the `web/` directory 
- **Hugo** (modern): In the `web-hugo/` directory

To build and serve the website locally:
```
# Jekyll version
$ nix build -f . web-jekyll && cd result && python -m http.server

# Hugo version (default)
$ nix build -f . web && cd result && python -m http.server

# Hugo development server (with live reload)
$ cd web-hugo && ./serve.sh
```

The default website implementation is set in `default.nix` with the `web = web-hugo;` line.

## Updating manifests

The .json files used for building the modpack are generated by modestly-modular-modpack-modifier
from the .yaml files in `manifest/`, and should always be updated after
any change to the .yaml files.
```
$ nix run ./modestly-modular-modpack-modifier -- -o manifest manifest/e32.yaml
```

If the current pack uses any mods from Curse, you will need to configure the Curse API client or mod resolution will fail.
See [Modestly Modular Modpack Modifier README](./modestly-modular-modpack-modifier/readme.adoc#config-file-sidebar) for instructions.

## General contribution workflow

Requires nix package manager and a unix environment (You can also use nixos!) of your choice to run it in.

1. Clone this repository
1. Create a directory to house the server
1. Navigate into it and run `../path/to/repository/update_and_start.sh` Choose the server you intend to build
1. Assuming all this succeeds, you can use any text editor to edit the files under manifest and base in the builder folder.  These files are the ones that influence what mods the server is running as well as the configs that get deployed to the client.

   Changing the manifest will not automatically change the running mods. See `Updating Manifests` for how to do that, and how to update mods to newer versions.

Once you've updated with cursetool and tried your changes with `update_and_start.sh` you can push your changes back up to the repo (use a branch or a fork please) and open a pull request against master.  At that point an admin can pull your changes into the server.

## Useful tips

* Dynmap quickly creates gigabytes of rendered map tiles. You might want to disable it while debugging.
* You aren't limited to running only the server. To test a new client configuration, look at the `ServerPackLocal` stance at the bottom of default.nix.

# License

Everything in this Git repository is MIT-licensed, with the exception
of the `third_party` directory and mods/configuration data in the `base`
directory; see third_party/README.md for details.

It isn't currently in shape for reuse, but if you wish to do so, make
sure to expunge base and third_party.
